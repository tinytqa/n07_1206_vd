const baseUrl = "https://localhost:7241/api/Parent";
let parentsData = [];

$(document).ready(function () {
    loadData();
});
function loadData() {
    $.ajax({
        url: `${baseUrl}/show`,
        method: 'GET',
        success: function (data) {
            parentsData = data;
            renderTable(data);
        },
        error: function (error) {
            alert('L·ªói khi t·∫£i d·ªØ li·ªáu');
            console.error(error);
        }
    });
}
function renderTable(data) {
    let html = '';
    data.forEach((parent) => {
        // üü¢ L·∫•y danh s√°ch t√™n h·ªçc sinh (n·∫øu c√≥)
        let studentNames = parent.students && parent.students.length > 0
            ? parent.students.map(s => s.stuName).join(', ')
            : 'Kh√¥ng c√≥ h·ªçc sinh'; // Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ h·ªçc sinh

        html += `
            <tr>
                <td>${parent.pId}</td>
                <td>${parent.pName}</td>
                <td>${parent.pPhone}</td>
                <td>${parent.pPassword}</td>
                <td>${studentNames}</td> <!-- C·∫≠p nh·∫≠t c√°ch hi·ªÉn th·ªã t√™n h·ªçc sinh -->
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openDialog('${parent.pId}')">S·ª≠a</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteParent('${parent.pId}')">X√≥a</button>
                </td>
            </tr>
        `;
    });
    $('#parentList').html(html);
}

function addParent() {
    var parentId = $('#parentID').val().trim();
    var parentName = $('#parentName').val().trim();
    var parentPhone = $('#parentPhone').val().trim();
    var parentPassword = $('#parentPassword').val().trim();
    var studentIds = $('#selectedStudentsInput').val().split(',')
        .map(id => id.trim())
        .filter(id => id !== ''); // L·ªçc b·ªè ID r·ªóng

    // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (!parentId || !parentName || !parentPhone || !parentPassword) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ph·ª• huynh.');
        return;
    }

    if (studentIds.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh.');
        return;
    }

    // T·∫°o query string t·ª´ danh s√°ch h·ªçc sinh
    var studentIdsQuery = studentIds.map(id => `studentIds=${encodeURIComponent(id)}`).join('&');

    // X√¢y d·ª±ng URL
    var queryString = `id=${encodeURIComponent(parentId)}&name=${encodeURIComponent(parentName)}&phone=${encodeURIComponent(parentPhone)}&pw=${encodeURIComponent(parentPassword)}&${studentIdsQuery}`;

    console.log("üü¢ Query String g·ª≠i l√™n API:", queryString);

    $.ajax({
        url: `${baseUrl}/insert?${queryString}`,
        method: 'POST',
        success: function (response) {
            alert('Th√™m ph·ª• huynh th√†nh c√¥ng!');
            loadData(); // C·∫≠p nh·∫≠t danh s√°ch ph·ª• huynh
            // Load l·∫°i danh s√°ch h·ªçc sinh
            closeStudentList();
            $('#parentForm')[0].reset();
            hideAddForm();
        },
        error: function (xhr, status, error) {
            console.error("L·ªói khi th√™m ph·ª• huynh:", xhr.responseText);
            alert(`L·ªói khi th√™m ph·ª• huynh: ${xhr.responseText || error}`);
        }
    });
}
function showAddForm() {
    document.getElementById('addParentPopup').style.display = 'flex';
}
function hideAddForm() {
    document.getElementById('addParentPopup').style.display = 'none';
}

let selectedStudents = []; // Bi·∫øn to√†n c·ª•c, kh√¥ng b·ªã reset m·ªói l·∫ßn m·ªü danh s√°ch
let selectedEditStudents = [];


function openDialog(parentId) {
    let parent = parentsData.find(p => p.pId === parentId);
    if (!parent) {
        alert("Kh√¥ng t√¨m th·∫•y ph·ª• huynh!");
        return;
    }

    $('#editParentId').val(parent.pId);
    $('#editParentName').val(parent.pName);
    $('#editParentPhone').val(parent.pPhone);
    $('#editParentPassword').val(parent.pPassword);

    // C·∫≠p nh·∫≠t danh s√°ch ID h·ªçc sinh ƒë√£ ch·ªçn
    selectedEditStudents = parent.students ? parent.students.map(s => s.stuId.toString()) : [];

    let studentNames = parent.students && parent.students.length > 0
        ? parent.students.map(s => s.stuName).join(', ')
        : '';
    $('#editselectedStudentsInput').val(studentNames);

    $('#editParentPopup').show();
}

function saveEditParent() {
    var parentId = $('#editParentId').val();
    var parentName = $('#editParentName').val();
    var parentPhone = $('#editParentPhone').val();
    var parentPassword = $('#editParentPassword').val();

    if (!parentId || !parentName || !parentPhone || !parentPassword) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.');
        return;
    }

    // T·∫°o query string
    var queryString = `id=${encodeURIComponent(parentId)}&` +
        `name=${encodeURIComponent(parentName)}&` +
        `phone=${encodeURIComponent(parentPhone)}&` +
        `pw=${encodeURIComponent(parentPassword)}`;

    // Th√™m danh s√°ch h·ªçc sinh v√†o query string n·∫øu c√≥
    if (selectedEditStudents && selectedEditStudents.length > 0) {
        selectedEditStudents.forEach(stuId => {
            queryString += `&studentIds=${encodeURIComponent(stuId)}`;
        });
    }

    // G·ª≠i request c·∫≠p nh·∫≠t
    $.ajax({
        url: `${baseUrl}/update?${queryString}`,
        method: 'POST',
        success: function (response) {
            alert('C·∫≠p nh·∫≠t th√¥ng tin ph·ª• huynh th√†nh c√¥ng!');
            $('#editParentPopup').hide();
            loadData();
        },
        error: function (error) {
            alert('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin ph·ª• huynh.');
            console.error(error);
        }
    });
}


function hideEditForm() {
    document.getElementById('editParentPopup').style.display = 'none';
}
function deleteParent(parentId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) {
        $.ajax({
            url: `${baseUrl}/delete?id=${encodeURIComponent(parentId)}`,
            method: 'DELETE',
            success: function (response) {
                loadData();
                alert('X√≥a th√†nh c√¥ng!');
            },
            error: function (error) {
                alert('L·ªói khi x√≥a d·ªØ li·ªáu');
                console.error(error);
            }
        });
    }
}

function openStudentList(isEdit = false) {
    try {
        fetch('https://localhost:7241/api/Student/show')
            .then(response => response.json())
            .then(students => {
                const studentTableBody = document.querySelector('#studentTable tbody');
                studentTableBody.innerHTML = ''; // X√≥a danh s√°ch c≈©

                let selectedList = isEdit 
                    ? (selectedEditStudents || []).map(String) 
                    : (selectedStudents || []).map(String);

                console.log("Danh s√°ch ID h·ªçc sinh ƒë√£ ch·ªçn:", selectedList);

                // L·ªçc danh s√°ch h·ªçc sinh d·ª±a v√†o tr·∫°ng th√°i Edit
                let availableStudents = isEdit
                    ? students.filter(student => selectedList.includes(student.stuId.toString()) || !student.stuP)
                    : students.filter(student => !student.stuP); // L·ªçc h·ªçc sinh ch∆∞a c√≥ ph·ª• huynh

                availableStudents.forEach(student => {
                    const row = document.createElement('tr');

                    const selectCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = student.stuId.toString();

                    // ‚úÖ Ki·ªÉm tra n·∫øu h·ªçc sinh ƒë√£ ƒë∆∞·ª£c ch·ªçn tr∆∞·ªõc ƒë√≥
                    checkbox.checked = selectedList.includes(checkbox.value);

                    if (checkbox.checked) {
                        console.log(`‚úîÔ∏è Checked: Student ID = ${student.stuId}, Name = ${student.stuName}`);
                    }

                    checkbox.onchange = function () {
                        if (this.checked) {
                            if (!selectedList.includes(this.value)) {
                                selectedList.push(this.value);
                            }
                        } else {
                            let index = selectedList.indexOf(this.value);
                            if (index !== -1) {
                                selectedList.splice(index, 1);
                            }
                        }

                        let selectedNames = students
                            .filter(s => selectedList.includes(s.stuId.toString()))
                            .map(s => s.stuName)
                            .join(', ');

                        if (isEdit) {
                            selectedEditStudents = [...selectedList];
                            document.getElementById('editselectedStudentsInput').value = selectedNames;
                        } else {
                            selectedStudents = [...selectedList];
                            document.getElementById('selectedStudentsInput').value = selectedNames;
                        }

                        console.log("üìå Danh s√°ch h·ªçc sinh ƒë√£ ch·ªçn:", selectedList);
                        console.log("üìå T√™n h·ªçc sinh hi·ªÉn th·ªã:", selectedNames);
                    };

                    selectCell.appendChild(checkbox);
                    row.appendChild(selectCell);

                    // C·ªôt th√¥ng tin h·ªçc sinh
                    //√î Student ID
                    const idCell = document.createElement('td');
                    idCell.textContent = student.stuId;
                    row.appendChild(idCell);

                    // √î Name
                    const nameCell = document.createElement('td');
                    nameCell.textContent = student.stuName;
                    row.appendChild(nameCell);

                    // √î Grade
                    const gradeCell = document.createElement('td');
                    gradeCell.textContent = student.stuGradeLevel;
                    row.appendChild(gradeCell);

                    // √î Date of Birth
                    const dobCell = document.createElement('td');
                    dobCell.textContent = student.stuDob;
                    row.appendChild(dobCell);

                    // √î Class
                    const classCell = document.createElement('td');
                    classCell.textContent = student.className || 'N/A';
                    row.appendChild(classCell);

                    studentTableBody.appendChild(row);
                });

                document.getElementById('studentListPopup').style.display = 'flex';

                console.log("Danh s√°ch h·ªçc sinh hi·ªÉn th·ªã:", availableStudents);
            })
            .catch(error => console.error('L·ªói khi t·∫£i danh s√°ch h·ªçc sinh:', error));
    } catch (error) {
        console.error('L·ªói ngo√†i:', error);
    }
}

function closeStudentList() {
    document.getElementById('studentListPopup').style.display = 'none';
}

function filterStudentList() {
    let searchValue = document.getElementById("searchStudentInput").value.toLowerCase();
    let rows = document.querySelectorAll("#studentTable tbody tr");

    rows.forEach(row => {
        let studentName = row.cells[2].textContent.toLowerCase(); // C·ªôt th·ª© 3 ch·ª©a t√™n h·ªçc sinh
        if (studentName.includes(searchValue)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}

function confirmSelectedStudents() {
    // L∆∞u danh s√°ch ID h·ªçc sinh ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥
    let previousSelected = [...selectedStudents];

    // L·∫•y t·∫•t c·∫£ checkbox ƒë√£ ƒë∆∞·ª£c ch·ªçn
    const checkboxes = document.querySelectorAll("#studentTable tbody input[type='checkbox']:checked");

    // C·∫≠p nh·∫≠t danh s√°ch selectedStudents
    selectedStudents = Array.from(checkboxes).map(checkbox => checkbox.value);

    // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ h·ªçc sinh n√†o ƒë∆∞·ª£c ch·ªçn
    if (selectedStudents.length === 0) {
        alert("‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh!");
        return; // D·ª´ng h√†m, kh√¥ng ƒë√≥ng popup
    }

    // Hi·ªÉn th·ªã danh s√°ch ID h·ªçc sinh ƒë√£ ch·ªçn v√†o textbox
    document.getElementById("selectedStudentsInput").value = selectedStudents.join(", ");

    console.log("‚úÖ Danh s√°ch ID h·ªçc sinh ƒë√£ ch·ªçn sau khi confirm:", selectedStudents);

    // N·∫øu c√≥ s·ª± thay ƒë·ªïi, log ra console
    if (JSON.stringify(previousSelected) !== JSON.stringify(selectedStudents)) {
        console.log("üîÑ Danh s√°ch h·ªçc sinh ƒë√£ thay ƒë·ªïi!");
    }

    closeStudentList(); // ƒê√≥ng dialog Select Students
}
